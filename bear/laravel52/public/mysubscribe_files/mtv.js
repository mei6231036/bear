function addTabEvent(a,t,e){for(var i=$(a),s=$(t),n=0;n<i.length;n++)i[n].index=n,i[n].onclick=function(){s.css({display:"none"}),i.removeClass(e);var a=this.index;$(this).addClass(e),s[a].style.display="block"}}function getWatchData(a){pageInfo.loading=!0,$.ajax({url:"http://fw.huya.com/dispatch?do=userHistory",type:"get",dataType:"jsonp",data:{uid:pageInfo.uid,pageSize:pageInfo.pageSize,page:a,token:pageInfo.token},success:function(a){if("1000"==a.status){var t=a.result;pageInfo.currentPage=t.currentPage,pageInfo.totalPages=t.totalPages,loadImg(t.historyList),checkItemStatus()}},error:function(a){window.console&&console.log(a),pageInfo.loading=!1}})}function success_jsonpCallback(a){if("1000"==a.status){var t=a.result;pageInfo.currentPage=t.currentPage,pageInfo.totalPages=t.totalPages,loadImg(t.historyList),checkItemStatus()}}function loadImg(a){$("#watch_history_loading").html('<em class="ico_loading"></em>下拉获取更多').show();for(var t="",e="",i="",s=!1,n=0,o=0;o<a.length;o++){var r=stamp2date(a[o].historyTime),c=null;o<a.length-1&&(c=stamp2date(a[o+1].historyTime)),pageInfo.preItemDate!=r.day&&(i&&$("#watch_history .item:last").after(i),s=!0,i="",n=0),e='<li class="'+(n++%2===0?"item_l":"")+'" data-link="'+(liveUrl+a[o].yyid)+'" data-aid="'+a[o].aid+'" data-uid="'+a[o].uid+'">'+(1===parseInt(a[o].isLive)?'<span class="live_icon">直播中</span>':"")+'<div class="img_wrap"><img src="'+a[o].avatar180+'" onerror="this.onerror=null;this.src=\'http://develop.www.huya.com/live2/statics/img/default_profile.jpg\'"/></div><div class="text_wrap"><p class="p_1">'+a[o].nick+'</p><p class="p_2">'+a[o].introduction+"</p>"+(1===parseInt(a[o].isLive)?'<p class="p_3">直播：<span class="game">'+a[o].gameName+'</span><span class="p_icon"></span><span>'+(+a[o].totalCount>9999?(+a[o].totalCount/1e4).toFixed(1)+"万":a[o].totalCount)+"</span></p>":'<p class="p_3">'+formatHistoryTime(a[o].historyTime)+'&nbsp;&nbsp;直播了：<span class="game">'+a[o].gameName+"</span></p>")+"</div></li>",i+=e,s?(o==a.length-1||c.day!=r.day)&&(t='<div class="content_wrap">						<div class="cont_tit"><span class="txt">'+r.year+"年"+r.month+"月"+r.date+'日</span></div>							<ul class="sub_wrap clearfix" style="padding-top:20px;">'+i+"</ul>						</div>",$("#watch_history_loading").before(t),i="",s=!1):o==a.length-1&&($("#watch_history .item:last").after(i),i=""),pageInfo.preItemDate=r.day}pageInfo.loading=!1,$("#watch_history_loading").hide()}function stamp2date(a){var t=new Date(1e3*a);return{day:t.toLocaleDateString(),year:t.getFullYear(),month:t.getMonth()+1,date:t.getDate()}}function getSubData(){$.ajax({type:"get",url:"http://api.huya.com/subscribe/getSubscribeToList?from_type=1",data:{from_key:pageInfo.uid},success:function(a){if(a.list&&a.list.length)for(var t=0,e=a.list.length;e>t;t++)pageInfo.subData.push(a.list[t].key)},dataType:"jsonp"})}function checkItemStatus(){$("#watch_history .sub_wrap li").each(function(a,t){{var e,i=$(t),s=i.data("uid")+"";i.data("aid")+""}e=pageInfo.subData.indexOf(s)>-1?'<a href="javascript:void(0);" class="his_sub" style="background-color:#d1d1d1;">已订阅</a>':'<a href="javascript:void(0);" class="his_sub" data-aid="'+s+'">+订阅</a>',i.find(".p_3").find(".his_sub")[0]&&i.find(".p_3").find(".his_sub").remove(),i.find(".p_3").append(e)})}function unMMSubscribe(a,t,e){$.ajax({type:"get",url:"http://open.m.yy.com/api/unsubscribe.action",dataType:"jsonp",data:{anchorCid:a,anchorUid:t,uid:userId},success:function(a){"0"==a&&$(e).parents("li").remove()}})}function formatHistoryTime(a){var a=+new Date-1e3*a,t=Math.round(a/1e3/60/60)||1,e=Math.round(t/24),i=Math.round(e/30);return i>30?"一个月前":e>0?e+"天前":t+"小时前"}addTabEvent("#subscribeTab a","#subscribeCont .mod-tab-content","cur"),addTabEvent("#subscribeWatchTab li","#subscribe_watch_wrap .J_content","selected"),$("#watch_history").delegate(".item","hover",function(){$(this).hasClass("disable")||$(this).toggleClass("item_hover")}).delegate(".close","click",function(a){a.preventDefault();var t=$(this).parents(".item_list"),e=$(this).parents(".content_wrap");alert(t.children().length),$(this).parents(".item").fadeOut("fast",function(){alert($(this).html()),0==t.children().length&&e.fadeOut("fast")})});var pageInfo={oldScrollTop:0,preItemDate:"1970/1/17",currentPage:0,totalPages:1,pageSize:15,loading:!1,subData:[]};$(function(){pageInfo.uid=main.getCookie("yyuid"),pageInfo.token=main.getCookie("udb_n"),$("body,html").animate({scrollTop:0},200),getWatchData(pageInfo.currentPage+1),$("#watch_history_loading").html("下拉获取更多"),$(window).scroll(function(){if(!pageInfo.loading){if(pageInfo.currentPage>=pageInfo.totalPages)return void $("#watch_history_loading").show().html("没有更多记录");var a=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;if(a>pageInfo.oldScrollTop){var t=$("#watch_history li:last");if(!t[0])return;var e=t.offset().top+t.height(),i=a+document.documentElement.clientHeight-e;Math.abs(i)<=150&&getWatchData(pageInfo.currentPage+1)}pageInfo.oldScrollTop=a}}),getSubData()}),$("#watch_history .sub_wrap li").live("click",function(){var a=$(this),t=a.data("link");window.open(t)}),$("#watch_history .sub_wrap .his_sub").live("click",function(a){var t=$(this),e=t.data("aid"),i=t.html();a.stopPropagation&&a.stopPropagation(),a.cancelBubble&&a.cancelBubble(),e&&"已订阅"!==i&&dy.activitySubscribe(e,"Subscribe")});